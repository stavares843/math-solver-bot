name: Add CI label

on:
  issue_comment:
    types: [created, edited]

jobs:
  solve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2

      - name: Add CI label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          COMMENT_BODY=$(jq -r '.comment.body' "$GITHUB_EVENT_PATH")

          # Check for /ci command
          if [[ "$COMMENT_BODY" =~ ^/ci[[:space:]]+(.+) ]]; then
            EXPRESSION="${BASH_REMATCH[1]}"

            # Add the "ci" label to the issue
            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST \
              "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$ISSUE_NUMBER/labels" \
              -d '{"labels":["ci"]}'

            if [[ "$EXPRESSION" =~ ^[0-9\+\-\*/\.\(\)[:space:]]+$ ]]; then
              RESULT=$(echo "$EXPRESSION" | bc)

              curl -s -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -X POST \
                "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$ISSUE_NUMBER/comments" \
                -d "$(jq -n --arg expr "$EXPRESSION" --arg res "$RESULT" \
                  '{body: ($expr + " = " + $res)}')"
            fi
          fi
