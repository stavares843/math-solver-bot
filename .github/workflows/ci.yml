name: CI / PR

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read
  checks: write
  issues: read

jobs:
  ci:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/ci')
    runs-on: ubuntu-latest

    steps:
      - name: Get PR SHA
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            })
            core.setOutput('sha', pr.data.head.sha)

      - name: Create CI check (pending)
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const res = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'CI / PR',
              head_sha: '${{ steps.pr.outputs.sha }}',
              status: 'in_progress'
            })
            core.setOutput('id', res.data.id)

      - uses: actions/checkout@v4

      - name: Fake CI
        run: |
          echo "Running CI..."
          sleep 10
          echo "CI done"

      - name: Complete CI check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: Number('${{ steps.check.outputs.id }}'),
              status: 'completed',
              conclusion: '${{ job.status }}'
            })
