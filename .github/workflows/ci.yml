name: Check Migrations

on:
  pull_request:
    branches: [main]
    paths:
      - "shared/migrations/models/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  check-migration-sequences:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate migration numbering (PR vs dev)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          MIG_DIR="shared/migrations/models"
          ENFORCE_AFTER=5

          if [ ! -d "$MIG_DIR" ]; then
            echo "Migration directory not found: $MIG_DIR"
            exit 0
          fi

          BASE_REF="${{ github.base_ref }}"
          THIS_PR="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          echo "Base branch: ${BASE_REF}"
          echo "Enforcing rules for migration numbers > ${ENFORCE_AFTER}"

          # Ensure we have latest dev
          git fetch origin "${BASE_REF}":"refs/remotes/origin/${BASE_REF}"

          extract_nums () {
            git ls-tree -r --name-only "$1" -- "$MIG_DIR" \
              | grep -E '\.py$' \
              | sed -E 's#^.*/##' \
              | grep -oP '^\d+' \
              || true
          }

          # -----------------------------
          # 1) Numbers on base branch
          # -----------------------------
          base_nums="$(extract_nums "origin/${BASE_REF}" | sort -n || true)"
          base_nums_enforced="$(printf "%s\n" ${base_nums:-} | awk -v n="$ENFORCE_AFTER" '$1 > n' | sort -n || true)"
          base_max="$(printf "%s\n" ${base_nums_enforced:-} | tail -n1 || echo "")"

          echo "Current max enforced migration in ${BASE_REF}: ${base_max:-none}"

          # -----------------------------
          # 2) Numbers in THIS PR
          # -----------------------------
          pr_nums="$(extract_nums "${{ github.sha }}" | sort -n || true)"
          pr_nums_enforced="$(printf "%s\n" ${pr_nums:-} | awk -v n="$ENFORCE_AFTER" '$1 > n' | sort -n || true)"

          failures=""

          # ---- A) Duplicate numbers inside THIS PR ----
          pr_dupes="$(printf "%s\n" ${pr_nums_enforced:-} | uniq -d || true)"
          if [ -n "${pr_dupes:-}" ]; then
            failures="${failures}
          ### Duplicate migration numbers inside this PR
          $(printf "%s\n" $pr_dupes | sed 's/^/- #/')
          "
          fi

          # ---- B) Numbers that already exist in dev ----
          clashes="$(comm -12 <(printf "%s\n" ${pr_nums_enforced:-} | sort) <(printf "%s\n" ${base_nums_enforced:-} | sort) || true)"
          if [ -n "${clashes:-}" ]; then
            failures="${failures}
          ### Migration numbers already exist in ${BASE_REF}
          $(printf "%s\n" $clashes | sed 's/^/- #/')
          "
          fi

          # ---- C) Sequence rule: must be greater than max in dev ----
          if [ -n "${base_max:-}" ] && [ -n "${pr_nums_enforced:-}" ]; then
            too_low="$(printf "%s\n" ${pr_nums_enforced:-} | awk -v max="$base_max" '$1 <= max')"
            if [ -n "${too_low:-}" ]; then
              failures="${failures}
          ### Migration numbers must be greater than ${base_max}
          $(printf "%s\n" $too_low | sed 's/^/- #/')
          "
            fi
          fi

          # -----------------------------
          # Final result
          # -----------------------------
          if [ -z "${failures:-}" ]; then
            echo "Migration numbering is valid."
            exit 0
          fi

          echo "::error::Migration numbering validation failed."

          comment_body="âŒ **Migration numbering validation failed**

          The following issues were found (enforced for numbers > ${ENFORCE_AFTER}):

          ${failures}

          **Fix:** Renumber your migration(s) to the next available number above ${base_max:-current max} and push an update.
          "

          gh api \
            --method POST \
            "/repos/${REPO}/issues/${THIS_PR}/comments" \
            -f body="$comment_body" || true

          exit 1
