name: Check Migrations

on:
  pull_request:
    branches: [main]
    paths:
      - "shared/migrations/models/**"

permissions:
  contents: read
  pull-requests: read

jobs:
  check-migration-sequences:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for duplicate migration numbers across open PRs
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          MIG_DIR="shared/migrations/models"
          ENFORCE_AFTER=5  # enforce uniqueness for migration numbers > 5

          if [ ! -d "$MIG_DIR" ]; then
            echo "Migration directory not found: $MIG_DIR"
            exit 0
          fi

          BASE_REF="${{ github.base_ref }}"
          THIS_PR="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          echo "Enforcing uniqueness for migration numbers > ${ENFORCE_AFTER}"
          echo "Base branch: ${BASE_REF}"
          echo "This PR: #${THIS_PR}"

          extract_nums_from_dir () {
            # Extract numeric prefix from filenames like "93_xyz.py" -> "93"
            (cd "$1" && ls *.py 2>/dev/null | grep -oP '^\d+' || true)
          }

          # ---- 1) Collect numbers from THIS PR working tree (enforced only) ----
          pr_nums="$(extract_nums_from_dir "$MIG_DIR" | sort -n || true)"
          pr_nums_enforced="$(printf "%s\n" $pr_nums | awk -v n="$ENFORCE_AFTER" '$1 > n' | sort -n || true)"

          # Fail if THIS PR itself has duplicate enforced numbers
          pr_dupes_enforced="$(printf "%s\n" $pr_nums_enforced | uniq -d || true)"
          if [ -n "$pr_dupes_enforced" ]; then
            echo "::error::This PR contains duplicate migration numbers (> ${ENFORCE_AFTER}): $(echo "$pr_dupes_enforced" | tr '\n' ' ')"
            echo ""
            echo "The following migration numbers have multiple files in this PR state:"
            for d in $pr_dupes_enforced; do
              echo "  #$d:"
              ls "$MIG_DIR" | grep -E "^${d}_" || true
            done
            echo ""
            echo "Fix: renumber your migration to the next available number."
            exit 1
          fi

          # ---- 2) Collect numbers from OTHER OPEN PRs targeting base ----
          tmp="$(mktemp)"
          trap 'rm -f "$tmp"' EXIT

          other_prs="$(gh api "/repos/${REPO}/pulls?state=open&base=${BASE_REF}&per_page=100" --jq '.[].number' \
                      | grep -v -x "${THIS_PR}" || true)"

          if [ -z "$other_prs" ]; then
            echo "No other open PRs targeting ${BASE_REF}."
          else
            echo "Other open PRs targeting ${BASE_REF}: $(echo "$other_prs" | tr '\n' ' ')"
          fi

          # Build list of "num<TAB>pr<TAB>filename" for enforced migrations across PRs.
          # Start with this PR:
          if [ -n "$pr_nums_enforced" ]; then
            while read -r n; do
              for f in $(ls "$MIG_DIR" | grep -E "^${n}_" || true); do
                printf "%s\t%s\t%s\n" "$n" "$THIS_PR" "$MIG_DIR/$f" >> "$tmp"
              done
            done <<< "$pr_nums_enforced"
          fi

          # Add other PRs:
          for pr in $other_prs; do
            gh api "/repos/${REPO}/pulls/${pr}/files?per_page=100" --paginate \
              --jq '.[] | .filename' \
              | awk -v dir="${MIG_DIR}/" '
                  index($0, dir) == 1 && $0 ~ /\.py$/ {
                    n=$0
                    sub(/^.*\//, "", n)
                    if (match(n, /^[0-9]+/)) {
                      num=substr(n, RSTART, RLENGTH)
                      print num "\t" $0
                    }
                  }
                ' \
              | while IFS=$'\t' read -r num file; do
                  if [ "$num" -gt "$ENFORCE_AFTER" ]; then
                    printf "%s\t%s\t%s\n" "$num" "$pr" "$file" >> "$tmp"
                  fi
                done
          done

          # ---- 3) Detect conflicts: same num claimed by 2+ different PRs ----
          conflicts="$(
            awk -F'\t' '
              { num=$1; pr=$2; key=num SUBSEP pr; seen[key]=1 }
              END {
                for (k in seen) {
                  split(k, a, SUBSEP)
                  prcount[a[1]]++
                }
                for (num in prcount) {
                  if (prcount[num] >= 2) print num
                }
              }
            ' "$tmp" | sort -n
          )"

          if [ -n "$conflicts" ]; then
            echo "::error::Migration number conflicts across open PRs (numbers > ${ENFORCE_AFTER}): $(echo "$conflicts" | tr '\n' ' ')"
            echo ""
            echo "Details:"
            while read -r num; do
              echo "  #$num is claimed by multiple open PRs:"
              awk -F'\t' -v n="$num" '$1==n { print "    PR #" $2 ": " $3 }' "$tmp" | sort -u
              echo ""
            done <<< "$conflicts"
            echo "Fix: renumber your migration to the next available number (coordinate if multiple PRs are open)."
            exit 1
          fi

          echo "No migration-number conflicts across open PRs (enforced for numbers > ${ENFORCE_AFTER})."
